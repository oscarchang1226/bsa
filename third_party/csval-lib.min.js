var CSVal=CSVal||{},APIVersion="1.9",FilterTags=[];if(CSVal.routes=CSVal.routes||{},CSVal.routes.get_whoami="/d2l/api/lp/"+APIVersion+"/users/whoami",CSVal.routes.get_userProfile="/d2l/api/lp/"+APIVersion+"/profile/",CSVal.routes.put_userProfile="/d2l/api/lp/"+APIVersion+"/profile/",CSVal.routes.get_toc="/d2l/api/le/"+APIVersion+"/ORGID/content/toc",CSVal.routes.get_grades="/d2l/api/le/"+APIVersion+"/ORGID/grades/values/myGradeValues/",CSVal.routes.get_news="/d2l/api/le/"+APIVersion+"/ORGID/news/",CSVal.routes.get_newsFile="/d2l/api/le/"+APIVersion+"/ORGID/news/NEWSID/attachments/FILEID",CSVal.routes.get_calendar="/d2l/api/le/"+APIVersion+"/ORGID/calendar/events/",CSVal.routes.get_enrollments="/d2l/api/lp/"+APIVersion+"/enrollments/myenrollments/",CSVal.routes.get_roles="/d2l/api/lp/"+APIVersion+"/roles/",CSVal.routes.get_forums="/d2l/api/le/"+APIVersion+"/ORGID/discussions/forums/",CSVal.routes.get_topics="/d2l/api/le/"+APIVersion+"/ORGID/discussions/forums/FORUMID/topics/",CSVal.routes.get_posts="/d2l/api/le/"+APIVersion+"/ORGID/discussions/forums/FORUMID/topics/TOPICID/posts/",CSVal.init_tracking=function(){this.timestamp=null,this.lock=!1,this.page=null,this.data=new Array},CSVal.devMode=1,CSVal.init=function(a){CSVal.context=CSVal.context||{},CSVal.user=CSVal.user||{},CSVal.t_profile=new CSVal.init_tracking,CSVal.toc=CSVal.toc||{},CSVal.t_toc=new CSVal.init_tracking,CSVal.grades=CSVal.grades||{},CSVal.t_grades=new CSVal.init_tracking,CSVal.news=CSVal.news||{},CSVal.t_news=new CSVal.init_tracking,CSVal.calendar=CSVal.calendar||{},CSVal.t_calendar=new CSVal.init_tracking,CSVal.enrollments=CSVal.enrollments||{},CSVal.t_enrollments=new CSVal.init_tracking,CSVal.roles=CSVal.roles||{},CSVal.t_roles=new CSVal.init_tracking,CSVal.disc=CSVal.disc||{},CSVal.tsS_discForums=CSVal.tsE_discForums=CSVal.tsS_discTopics=CSVal.tsE_discTopics=CSVal.tsS_discPosts=CSVal.tsE_discPosts=null,CSVal.disc.postLimit=0,CSVal.params=CSVal.params||{},CSVal.params.profile_strings={Nickname:128,HomeTown:128,Email:128,HomePage:128,HomePhone:20,BusinessPhone:20,MobilePhone:20,FaxNumber:20,Address1:128,Address2:128,City:128,Province:20,PostalCode:20,Country:20,Company:128,JobTitle:128,HighSchool:128,University:128,Hobbies:1e4,FavMusic:1e4,FavTVShows:1e4,FavMovies:1e4,FavBooks:1e4,FavQuotations:1e4,FavWebSites:1e4,FutureGoals:1e4,FavMemory:1e4,Social_Facebook:128,Social_Twitter:128,Social_Google:128,Social_LinkedIn:128};var c=(window.location.href,window.top.location.href),d=c.split("/");c.indexOf("/m/")>-1?(CSVal.context.ouID=d[7],CSVal.context.contentTopicID=d[10]):(CSVal.context.ouID=d[6],CSVal.context.contentTopicID=d[8]),void 0==CSVal.context.ouID&&(CSVal.context.ouID=parent.ouID),void 0!==a&&FilterTags instanceof Array==!0&&a.indexOf("myprofile")>-1&&pubsubz.subscribe("csval/get_whoami",CSVal.get_userProfile),1==CSVal.devMode&&console.log(CSVal.context),CSVal.get_whoami(),pubsubz.publish("csval/init")},CSVal.get_whoami=function(){valence_req.get(CSVal.routes.get_whoami).use(valence_auth).end(function(a,b){if(null!=a)return console.log("csval.get_whoami error:"),console.log(b),errorPrompt(a,CSVal.routes.get_whoami,"alert"),!1;for(var c in b.body)CSVal.user[c]=b.body[c];CSVal.user.ID=CSVal.user.Identifier,pubsubz.publish("csval/get_whoami"),1==CSVal.devMode&&(console.log("CSVal.user:"),console.log(CSVal.user))})},CSVal.get_userProfile=function(a){if(void 0==a){if(a="myProfile",CSVal.t_profile.lock!==!1)return console.info("CSVal.get_userProfile was called while a previous Profile request is still being processed"),!1;CSVal.t_profile.lock=!0}valence_req.get(CSVal.routes.get_userProfile+a).use(valence_auth).end(function(b,c){return null!=b?(errorPrompt(b,CSVal.routes.get_userProfile,"alert"),CSVal.t_profile.lock=!1,!1):("myProfile"==a?(CSVal.user.profile={},CSVal.user.profile=c.body,CSVal.t_profile.timestamp=new Date,CSVal.t_profile.lock=!1,pubsubz.publish("csval/get_userProfile")):pubsubz.publish("csval/get_userProfile",c.body),void(1==CSVal.devMode&&(console.log("CSVal.user.profile:"),console.log(CSVal.user.profile))))})},CSVal.put_userProfile=function(a,b){if(void 0==a){if(a="myProfile",b=CSVal.user.profile,CSVal.t_profile.lock!==!1)return console.info("CSVal.put_userProfile was called while a previous Profile request is still being processed"),!1;CSVal.t_profile.lock=!0}else if(void 0==b)return!1;valence_req.put(CSVal.routes.put_userProfile+a).send(b).use(valence_auth).end(function(b,c){return null!=b?(errorPrompt(b,CSVal.routes.put_userProfile,"alert"),!1):void("myProfile"==a?(CSVal.user.profile=c.body,CSVal.t_profile.timestamp=new Date,CSVal.t_profile.lock=!1,pubsubz.publish("csval/put_userProfile")):pubsubz.publish("csval/put_userProfile",c.body))})},CSVal.get_toc=function(a){var b;if(void 0===a){if(CSVal.t_toc.lock!==!1)return console.info("CSVal.get_toc was called while a previous ToC request is still being processed"),!1;CSVal.t_toc.lock=!0,b=CSVal.routes.get_toc.replace("ORGID",CSVal.context.ouID)}else b=CSVal.routes.get_toc.replace("ORGID",a);valence_req.get(b).use(valence_auth).end(function(b,c){if(null!=b)return errorPrompt(b,CSVal.routes.get_toc,"alert"),CSVal.t_toc.lock=!1,!1;if(void 0===a)CSVal.toc=CSVal.toc_parse(c.body),CSVal.t_toc.timestamp=new Date,CSVal.t_toc.lock=!1,pubsubz.publish("csval/get_toc"),1==CSVal.devMode&&(console.log("CSVal.toc:"),console.log(CSVal.toc));else{var d={orgUnitId:a,toc:c.body};pubsubz.publish("csval/get_toc/"+a,d)}})},CSVal.get_grades=function(){return CSVal.t_grades.lock!==!1?(console.info("CSVal.get_grades was called while a previous Grades request is still being processed"),!1):(CSVal.t_grades.lock=!0,CSVal.routes.get_grades=CSVal.routes.get_grades.replace("ORGID",CSVal.context.ouID),void valence_req.get(CSVal.routes.get_grades).use(valence_auth).end(function(a,b){return null!=a?(errorPrompt(a,CSVal.routes.get_grades,"alert"),CSVal.t_grades.lock=!1,!1):(CSVal.grades=b.body,CSVal.t_grades.timestamp=new Date,CSVal.t_grades.lock=!1,pubsubz.publish("csval/get_grades"),void(1==CSVal.devMode&&(console.log("CSVal.grades:"),console.log(CSVal.grades))))}))},CSVal.get_news=function(){return CSVal.t_news.lock!==!1?(console.info("CSVal.get_news was called while a previous News request is still being processed"),!1):(CSVal.t_news.lock=!0,CSVal.routes.get_news=CSVal.routes.get_news.replace("ORGID",CSVal.context.ouID),void valence_req.get(CSVal.routes.get_news).use(valence_auth).end(function(a,b){return null!=a?(errorPrompt(a,CSVal.routes.get_news,"alert"),CSVal.t_news.lock=!1,!1):(CSVal.news=JSON.parse(JSON.stringify(b.body),JSON.dateParser),CSVal.t_news.timestamp=new Date,CSVal.t_news.lock=!1,pubsubz.publish("csval/get_news"),void(1==CSVal.devMode&&(console.log("CSVal.news:"),console.log(CSVal.news))))}))},CSVal.get_newsFile=function(a,b,c){return void 0!==c&&(fileURL=CSVal.routes.get_newsFile.replace("ORGID",a).replace("NEWSID",b).replace("FILEID",c),void valence_req.get(fileURL).use(valence_auth).end(function(a,b){return null!=a?(errorPrompt(a,CSVal.routes.get_news,"alert"),!1):(console.log("response from get_newsFile:"),void console.log(b))}))},CSVal.get_calendar=function(){return CSVal.t_calendar.lock!==!1?(console.info("CSVal.get_calendar was called while a previous Calendar request is still being processed"),!1):(CSVal.t_calendar.lock=!0,CSVal.routes.get_calendar=CSVal.routes.get_calendar.replace("ORGID",CSVal.context.ouID),void valence_req.get(CSVal.routes.get_calendar).use(valence_auth).end(function(a,b){if(null!=a)return errorPrompt(a,CSVal.routes.get_calendar,"alert"),CSVal.t_calendar.lock=!1,!1;for(var c=0;c<b.body.length;c++)null==b.body[c].StartDay?b.body[c].StartDay=b.body[c].StartDateTime:null==b.body[c].StartDateTime&&(b.body[c].StartDateTime=b.body[c].StartDay),null==b.body[c].EndDay?b.body[c].EndDay=b.body[c].EndDateTime:null==b.body[c].EndDateTime&&(b.body[c].EndDateTime=b.body[c].EndDay),null!==b.body[c].AssociatedEntity&&("D2L.LE.Quizzing.Quiz"==b.body[c].AssociatedEntity.AssociatedEntityType&&(b.body[c].AssociatedEntity.Type="Quiz"),"D2L.LE.Discussions.DiscussionTopic"==b.body[c].AssociatedEntity.AssociatedEntityType&&(b.body[c].AssociatedEntity.Type="Discussion"),"D2L.LE.Dropbox.Dropbox"==b.body[c].AssociatedEntity.AssociatedEntityType&&(b.body[c].AssociatedEntity.Type="Dropbox"),"D2L.LE.Survey.Survey"==b.body[c].AssociatedEntity.AssociatedEntityType&&(b.body[c].AssociatedEntity.Type="Survey"),"D2L.LE.Checklist.ChecklistItem"==b.body[c].AssociatedEntity.AssociatedEntityType&&(b.body[c].AssociatedEntity.Type="Checklist"));CSVal.calendar=JSON.parse(JSON.stringify(b.body),JSON.dateParser),CSVal.t_calendar.timestamp=new Date,CSVal.t_calendar.lock=!1,pubsubz.publish("csval/get_calendar"),1==CSVal.devMode&&(console.log("CSVal.calendar:"),console.log(CSVal.calendar))}))},CSVal.get_enrollments=function(a){var b=CSVal.routes.get_enrollments;return CSVal.t_enrollments.lock!==!1&&void 0===a?(console.info("CSVal.get_enrollments was called while a previous Enrollments request is still being processed"),!1):void 0!==a&&null==CSVal.t_enrollments.page?(console.warn("CSVal.get_enrollments was called incorrectly with an argument"),!1):(void 0!==a&&(b+="?bookmark="+CSVal.t_enrollments.page),CSVal.t_enrollments.lock=!0,void valence_req.get(b).use(valence_auth).end(function(a,b){if(null!=a)return errorPrompt(a,CSVal.routes.get_enrollments,"alert"),CSVal.t_enrollments.lock=!1,!1;var c=CSVal.t_enrollments.data;CSVal.t_enrollments.data=c.concat(JSON.parse(JSON.stringify(b.body.Items),JSON.dateParser)),1==b.body.PagingInfo.HasMoreItems&&CSVal.t_enrollments.data.length<1e3?(CSVal.t_enrollments.page=b.body.PagingInfo.Bookmark,CSVal.get_enrollments(!0)):(CSVal.t_enrollments.page=null,CSVal.enrollments=CSVal.t_enrollments.data,CSVal.t_enrollments.data=new Array,CSVal.t_enrollments.timestamp=new Date,CSVal.t_enrollments.lock=!1,pubsubz.publish("csval/get_enrollments"),1==CSVal.devMode&&(console.log("CSVal.enrollments:"),console.log(CSVal.enrollments)))}))},CSVal.get_roles=function(a){var b;if(void 0===a){if(CSVal.t_roles.lock!==!1)return console.info("CSVal.get_roles was called while a previous Roles request is still being processed"),!1;CSVal.t_roles.lock=!0,b=CSVal.routes.get_roles}else b=CSVal.routes.get_roles+a;valence_req.get(b).use(valence_auth).end(function(b,c){return null!=b?(errorPrompt(b,CSVal.routes.get_roles,"alert"),CSVal.t_roles.lock=!1,!1):void(void 0===a?(CSVal.roles=c.body,CSVal.t_roles.timestamp=new Date,CSVal.t_roles.lock=!1,pubsubz.publish("csval/get_roles"),1==CSVal.devMode&&(console.log("CSVal.roles:"),console.log(CSVal.roles))):pubsubz.publish("csval/get_roles/"+a,c.body))})},CSVal.toc_parse=function(a){void 0==a&&(a=CSVal.toc);if(a.Progress={Read:0,Total:0,Percentage:0},void 0!==a.Modules)for(var d=0;d<a.Modules.length;d++)a.Modules[d]=CSVal.toc_parse(a.Modules[d]),a.Progress.Total+=a.Modules[d].Progress.Total,a.Progress.Read+=a.Modules[d].Progress.Read;else a.Modules=[];if(void 0!==a.Topics)for(var e=0;e<a.Topics.length;e++)a.Progress.Total++,0==a.Topics[e].Unread&&a.Progress.Read++,"Link"==a.Topics[e].TypeIdentifier&&"/d2l"==a.Topics[e].Url.substr(0,4)?(a.Topics[e].Url.indexOf("&type=discuss&")>-1?a.Topics[e].Type="Discussion":a.Topics[e].Url.indexOf("&type=dropbox&")>-1?a.Topics[e].Type="Dropbox":a.Topics[e].Url.indexOf("&type=quiz&")>-1?a.Topics[e].Type="Quiz":a.Topics[e].Url.indexOf("&type=checklist&")>-1?a.Topics[e].Type="Checklist":a.Topics[e].Url.indexOf("&type=selfassess&")>-1?a.Topics[e].Type="SelfAssessment":a.Topics[e].Url.indexOf("&type=survey&")>-1&&(a.Topics[e].Type="Survey"),a.Topics[e].Source="Internal"):"Link"==a.Topics[e].TypeIdentifier?(a.Topics[e].Type=a.Topics[e].Url.substr((~-a.Topics[e].Url.lastIndexOf(".")>>>0)+2),a.Topics[e].Source="External"):"File"==a.Topics[e].TypeIdentifier?null!==a.Topics[e].Url&&(a.Topics[e].Type=a.Topics[e].Url.substr((~-a.Topics[e].Url.lastIndexOf(".")>>>0)+2),a.Topics[e].Source="Internal"):(a.Topics[e].Type="unknown",a.Topics[e].Source="unknown");else a.Topics=[];return a.Progress.Percentage=0==a.Progress.Total?0:a.Progress.Read/a.Progress.Total*100,a},CSVal.toc_addGrades=function(a){var b=!1;if(void 0==a&&(a=CSVal.clone_toc(),b=!0),null===CSVal.t_toc.timestamp)return pubsubz.subscribe("csval/get_toc",CSVal.toc_addGrades),CSVal.get_toc(),!1;if(null===CSVal.t_grades.timestamp)return pubsubz.subscribe("csval/get_grades",CSVal.toc_addGrades),CSVal.get_grades(),!1;if(void 0!==a.Modules)for(var c=0;c<a.Modules.length;c++)a.Modules[c]=CSVal.toc_addGrades(a.Modules[c]);if(void 0!==a.Topics)for(var d=0;d<a.Topics.length;d++)for(var e=0;e<CSVal.grades.length;e++)a.Topics[d].Title==CSVal.grades[e].GradeObjectName&&(a.Topics[d].Grade=CSVal.grades[e]);return b?(CSVal.toc=a,pubsubz.publish("csval/toc_addGrades"),!0):a},CSVal.toc_filter=function(a,b,c){if(void 0==a)return!1;if(void 0==b||"object"!=typeof b||b instanceof Array!=!0)return!1;void 0==c&&(c=JSON.parse(JSON.stringify(CSVal.toc),JSON.dateParser),console.warning("no module provided"));var d=!1,e=[],f="",g="";if(void 0!==c.Modules)for(var h=0;h<c.Modules.length;h++){var i=CSVal.toc_filter(a,b,c.Modules[h]);i!==!1?(c.Modules[h]=i,d=!0):(c.Modules.splice(h,1),h--)}if(void 0!==c.Topics)for(var j=0;j<c.Topics.length;j++)for(var k=0;k<b.length;k++)if(g=b[k].toLowerCase(),"title"==a.toLowerCase())f=c.Topics[j].Title.toLowerCase(),f.indexOf(g)>-1&&e.push(c.Topics[j]);else{if("type"!=a.toLowerCase())return!1;f=c.Topics[j].Type.toLowerCase(),f==g&&e.push(c.Topics[j])}return c.Topics=e,(0!=d||0!=c.Topics.length)&&c},CSVal.toc_toHTML=function(a,b){var c=!1;if(void 0==a){if(void 0===CSVal.toc||void 0===CSVal.toc.Modules)return console.error("Table of Contents has not been loaded before calling CSVal.toc_toHTML"),"";a=CSVal.toc,c=!0}else void 0==b&&(c=!0);var d="";if(0==c?(d+='<li class="toc-module toc-module-expanded" data-read="'+a.Progress.Read+'" data-total="'+a.Progress.Total+'">',void 0!==a.Title&&(d+='<div class="toc-module-title">'+a.Title+"</div>"),d+="\n<ul>\n"):d+="<ul>\n",void 0!==a.Modules)for(var e=0;e<a.Modules.length;e++)void 0!==a.Modules[e].Title&&(d+=CSVal.toc_toHTML(a.Modules[e],!0));if(void 0!==a.Topics)for(var f=0;f<a.Topics.length;f++){var g=unread=type=grade="";"External"==a.Topics[f].Source&&(g=' target="_blank"'),1==a.Topics[f].Unread&&(unread=" toc-topic-unread"),"Link"==a.Topics[f].TypeIdentifier&&"Internal"==a.Topics[f].Source?type=" toc-type-d2l-"+a.Topics[f].Type:"Link"==a.Topics[f].TypeIdentifier?type=" toc-type-link":type=" toc-type-file-"+a.Topics[f].Type,void 0!==a.Topics[f].Grade&&(grade='<span class="toc-topic-grade">'+a.Topics[f].Grade.DisplayedGrade+"</span>"),d+='<li class="toc-topic'+unread+type+'"><a href="'+a.Topics[f].Url+'"'+g+">"+a.Topics[f].Title+"</a>"+grade+"</li>\n"}return d+=0==c?"</ul>\n</li>\n":"</ul>\n",1==c&&(d=d.replace("toc-topic-unread","toc-topic-unread toc-topic-next")),d.indexOf("toc-topic")==-1?"":d},CSVal.toc_nextUnread=function(a,b){if(void 0==a&&(a=CSVal.toc),void 0!==b){if("number"!=typeof b)return!1}else b=0;if(void 0!==a.Modules)for(var c=b;c<a.Modules.length;c++)if(topicID=CSVal.toc_nextUnread(a.Modules[c]),topicID!==!1)return topicID;if(void 0!==a.Topics)for(var d=0;d<a.Topics.length;d++)if(1==a.Topics[d].Unread)return a.Topics[d];return!1},CSVal.news_toHTML=function(a){if(void 0==a){if(void 0===CSVal.news||0==CSVal.news.length)return console.warn("News has not been loaded (or no news exists) before calling CSVal.news_toHTML"),"";a=CSVal.news}for(var b="<ul>\n",c=0;c<a.length;c++)if(0==a[c].IsHidden){var d="";if(void 0!==a[c].Attachments&&a[c].Attachments.length>0){d='<ul class="news-attachments">\n';for(var e=0;e<a[c].Attachments.length;e++){var f=a[c].Attachments[e].Size,g="";g=f/1073741824>1?Math.round(f/1073741824)+"GB":f/1048576>1?Math.round(f/1048576)+"MB":f/1024>1?Math.round(f/1024)+"KB":f+" bytes",fileURL="javascript:CSVal.get_newsFile("+CSVal.context.ouID+","+a[c].Id+","+a[c].Attachments[e].FileId+");",d+='<li class="news-attachment"><a href="../../thirdpartylib/'+fileURL+'">'+a[c].Attachments[e].FileName+"</a> ("+g+")</li>\n"}d+="</ul>\n"}b+='<li class="news-item"><div class="news-head"><span class="news-title">'+a[c].Title+'</span><span class="news-date">'+a[c].StartDate.toLocaleDateString()+'</span> <span class="news-time">'+a[c].StartDate.toLocaleTimeString()+'</div>\n<div class="news-body">'+a[c].Body.Html+"</div>\n"+d+"</li>\n"}return b+="</ul>\n"},CSVal.calendar_toHTML=function(a){if(void 0==a){if(void 0===CSVal.calendar||0==CSVal.calendar.length)return console.warn("Calendar has not been loaded (or no events exist) before calling CSVal.calendar_toHTML"),"";a=CSVal.calendar}for(var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],c="<ul>\n",d="",e=0;e<a.length;e++)d=null!==a[e].AssociatedEntity?" calendar-type-d2l-"+a[e].AssociatedEntity.Type:"",c+='<li class="calendar-item'+d+' cf"><div class="calendar-day"><span class="calendar-month">'+b[a[e].EndDateTime.getMonth()]+'</span><span class="calendar-date">'+a[e].EndDateTime.getDate()+'</span></div><div class="calendar-details"><div class="calendar-title">'+a[e].Title+'</div><div class="calendar-description">'+a[e].Description+'</div><div class="calendar-type"></div></div></li>\n';return c+="</ul>\n"},CSVal.calendar_filter=function(a,b,c,d){if(void 0!==b&&"object"==typeof b&&b instanceof Array==!0||(a=[0,90]),void 0!==b&&"object"==typeof b&&b instanceof Array==!0||(b=[]),void 0===d){if(null===CSVal.tsE_calendar)return!1;d=JSON.parse(JSON.stringify(CSVal.calendar),JSON.dateParser)}for(var e=filteredTags=filteredEvents=[],f=new Date,g=new Date(f.getTime()-864e5*a[0]),h=new Date(f.getTime()+864e5*a[1]),i=0;i<d.length;i++)(d[i].StartDateTime>=g&&d[i].StartDateTime<h||d[i].EndDateTime>g&&d[i].EndDateTime<=h||d[i].StartDateTime<g&&d[i].EndDateTime>h)&&e.push(d[i]);for(i=0;i<e.length;i++)for(var j=0;j<b.length;j++)e[i].Title.toLowerCase().indexOf(b[j].toLowerCase())>-1&&filteredTags.push(e[i]);for(i=0;i<filteredTags.length;i++)if(null!==filteredTags[i].AssociatedEntity)for(j=0;j<c.length;j++)filteredTags[i].AssociatedEntity.Type.toLowerCase()==c[j].toLowerCase()&&filteredEvents.push(filteredTags[i]);return filteredEvents},CSVal.news_filter=function(a,b,c){if(void 0===a&&(a=14),void 0!==b&&"object"==typeof b&&b instanceof Array==!0||(b=[]),void 0===c){if(null===CSVal.tsE_news)return!1;c=JSON.parse(JSON.stringify(CSVal.news),JSON.dateParser)}for(var d=filteredNews=[],e=new Date,f=new Date(e.getTime()-864e5*a),g=0;g<c.length;g++)c[g].StartDate>=f&&c[g].StartDate<=e&&c[g].IsHidden===!1&&c[g].IsPublished===!0&&d.push(c[g]);for(g=0;g<b.length;g++)for(var h=0;h<d.length;h++)d[h].Title.toLowerCase().indexOf(b[g].toLowerCase())>-1&&filteredNews.push(d[h]);return filteredNews},CSVal.profile_edit=function(a,b){var c;if(void 0===a||void 0===b)return console.warn("CSVal.profile_edit was called without providing enough data"),!1;if("Birthday"==a){if(b instanceof Array!=!0||2!==b.length)return console.warn("CSVal.profile_edit was called with invalid data"),!1;if((4==b[0]||6==b[0]||9==b[0]||11==b[0])&&b[1]>30||2==b[0]&&b[1]>29||b[0]<1||b[0]>12||b[1]>31||b[1]<1)return console.warn("CSVal.profile_edit was called with an invalid birthday value"),!1;CSVal.user.profile.Birthday.Month=b[0],CSVal.user.profile.Birthday.Day=b[1]}else if("Social_Facebook"==a&&b.length<CSVal.params.profile_strings.Social_Facebook)for(c=0;c<CSVal.user.profile.SocialMediaUrls;c++)"Facebook"==CSVal.user.profile.SocialMediaUrls[c].Name&&(CSVal.user.profile.SocialMediaUrls[c].Url=b);else if("Social_Twitter"==a&&b.length<CSVal.params.profile_strings.Social_Twitter)for(c=0;c<CSVal.user.profile.SocialMediaUrls;c++)"Twitter"==CSVal.user.profile.SocialMediaUrls[c].Name&&(CSVal.user.profile.SocialMediaUrls[c].Url=b);else if("Social_Google"==a&&b.length<CSVal.params.profile_strings.Social_Google)for(c=0;c<CSVal.user.profile.SocialMediaUrls;c++)"Google"==CSVal.user.profile.SocialMediaUrls[c].Name&&(CSVal.user.profile.SocialMediaUrls[c].Url=b);else if("Social_LinkedIn"==a&&b.length<CSVal.params.profile_strings.Social_LinkedIn)for(c=0;c<CSVal.user.profile.SocialMediaUrls;c++)"LinkedIn"==CSVal.user.profile.SocialMediaUrls[c].Name&&(CSVal.user.profile.SocialMediaUrls[c].Url=b);else{if(!(a in CSVal.params.profile_strings&&b.length<=CSVal.params.profile_strings[a]))return console.warn("CSVal.profile_edit was called with invalid data"),!1;CSVal.user.profile[a]=b}return!0},CSVal.clone_toc=function(){return JSON.parse(JSON.stringify(CSVal.toc),JSON.dateParser)},CSVal.clone_grades=function(){return JSON.parse(JSON.stringify(CSVal.grades),JSON.dateParser)},CSVal.clone_news=function(){return JSON.parse(JSON.stringify(CSVal.news),JSON.dateParser)},CSVal.clone_calendar=function(){return JSON.parse(JSON.stringify(CSVal.calendar),JSON.dateParser)},CSVal.clone_profile=function(){return JSON.parse(JSON.stringify(CSVal.user.profile),JSON.dateParser)},CSVal.get_forums=function(){return null==CSVal.tsS_discForums&&(CSVal.tsS_discForums=new Date,CSVal.routes.get_forums=CSVal.routes.get_forums.replace("ORGID",CSVal.context.ouID),pubsubz.subscribe("csval/get_forums",CSVal.get_topics),void valence_req.get(CSVal.routes.get_forums).use(valence_auth).end(function(a,b){return null!=a?(errorPrompt(a,CSVal.routes.get_forums,"alert"),!1):(CSVal.disc.Forums=b.body,CSVal.disc.ForumsLoaded=0,CSVal.disc.ForumsCalled=0,CSVal.tsE_discForums=new Date,void pubsubz.publish("csval/get_forums"))}))},CSVal.get_topics=function(){if(null===CSVal.tsE_discForums)return pubsubz.subscribe("csval/get_forums",CSVal.get_topics),!1;if(CSVal.tsS_discTopics=new Date,0===CSVal.disc.Forums.length)return console.warning("CSVal: There are no Discussion Forums associated with the current context."),!1;for(var b,a=CSVal.routes.get_topics.replace("ORGID",CSVal.context.ouID),c=0;c<CSVal.disc.Forums.length;c++)CSVal.disc.ForumsCalled++,CSVal.disc.Forums[c].Topics=new Array,b=a.replace("FORUMID",CSVal.disc.Forums[c].ForumId),valence_req.get(b).use(valence_auth).end(function(a,b){if(null!=a)return errorPrompt(a,topicURL,"alert"),!1;var c=b.body;if(c.length>0)for(var d=c[0].ForumId,e=0;e<CSVal.disc.Forums.length;e++)if(CSVal.disc.Forums[e].ForumId==d){CSVal.disc.Forums[e].Topics=c;for(var f=0;f<CSVal.disc.Forums[e].Topics.length;f++)CSVal.disc.Forums[e].Topics[f].IgnorePosts=!0,CSVal.disc.Forums[e].Topics[f].UserPosts=0,CSVal.disc.Forums[e].Topics[f].Posts=new Array,CSVal.disc.Forums[e].Topics[f].PostsPage=0;break}CSVal.disc.ForumsLoaded++,CSVal.disc.ForumsCalled===CSVal.disc.Forums.length&&CSVal.disc.ForumsCalled===CSVal.disc.ForumsLoaded&&null===CSVal.tsE_discTopics&&(CSVal.tsE_discTopics=new Date,pubsubz.publish("csval/get_topics"))})},CSVal.topic_filter=function(a,b,c){if(void 0===a||void 0===b||void 0===c)return console.warn("CSVal.disc_filter was called without the proper parameters"),!1;if(null===CSVal.tsE_discTopics)return pubsubz.subscribe("csval/get_topics",function(a,b,c){CSVal.get_topics(a,b,c)}),!1;var d=j=x=0,e=targetString="";for(d=0;d<CSVal.disc.Forums.length;d++){for(x=0;x<a.length;x++)if(CSVal.disc.Forums[d].ForumId===a[x])for(j=0;j<CSVal.disc.Forums[d].Topics.length;j++)CSVal.disc.Forums[d].Topics[j].IgnorePosts=!1;for(x=0;x<b.length;x++)if(e=CSVal.disc.Forums[d].Name.toLowerCase(),targetString=b[x].toLowerCase(),seachString.indexOf(targetString)>-1)for(j=0;j<CSVal.disc.Forums[d].Topics.length;j++)CSVal.disc.Forums[d].Topics[j].IgnorePosts=!1;for(j=0;j<CSVal.disc.Forums[d].Topics.length;j++)for(e=CSVal.disc.Forums[d].Topics[j].Name.toLowerCase(),x=0;x<c.length;x++)targetString=c[x].toLowerCase(),e.indexOf(targetString)>-1&&(CSVal.disc.Forums[d].Topics[j].IgnorePosts=!1)}return!0},CSVal.get_posts=function(a){if(null!==a&&a===!0||(a=!1),null===CSVal.tsE_discTopics)return pubsubz.subscribe("csval/get_topics",CSVal.get_posts),!1;CSVal.tsS_discPosts=new Date;for(var d,c=(CSVal.disc.postLimit>0&&CSVal.disc.postLimit<1e3?CSVal.disc.postLimit:1e3,CSVal.routes.get_posts.replace("ORGID",CSVal.context.ouID)),e=0;e<CSVal.disc.Forums.length;e++)for(var f=0;f<CSVal.disc.Forums[e].Topics.length;f++)a!==!0&&CSVal.disc.Forums[e].Topics[f].IgnorePosts!==!1||(d=c.replace("FORUMID",CSVal.disc.Forums[e].ForumId).replace("TOPICID",CSVal.disc.Forums[e].Topics[f].TopicId),valence_req.get(d).use(valence_auth).end(function(a,b){if(null!=a)return errorPrompt(a,d,"alert"),!1;b.body}))},CSVal.set_postLimit=function(a){(void 0===a||"number"!=typeof a||a<0)&&(a=0),CSVal.disc.postLimit=Math.round(a)},CSVal.disc_toHTML=function(a,b,c,d,e){if(null===CSVal.tsE_discTopics)return pubsubz.subscribe("csval/get_topics",CSVal.get_posts),!1;var f=j=x=0,g=targetString="";for(f=0;f<CSVal.disc.Forums.length;f++){for(x=0;x<c.length;x++)if(CSVal.disc.Forums[f].ForumId===c[x])for(j=0;j<CSVal.disc.Forums[f].Topics.length;j++)CSVal.disc.Forums[f].Topics[j].IgnorePosts=!1;for(x=0;x<d.length;x++)if(g=CSVal.disc.Forums[f].Name.toLowerCase(),targetString=d[x].toLowerCase(),seachString.indexOf(targetString)>-1)for(j=0;j<CSVal.disc.Forums[f].Topics.length;j++)CSVal.disc.Forums[f].Topics[j].IgnorePosts=!1;for(j=0;j<CSVal.disc.Forums[f].Topics.length;j++)for(g=CSVal.disc.Forums[f].Topics[j].Name.toLowerCase(),x=0;x<e.length;x++)targetString=e[x].toLowerCase(),g.indexOf(targetString)>-1&&(CSVal.disc.Forums[f].Topics[j].IgnorePosts=!1)}},CSVal.disc_latestToHTML=function(a,b,c,d){if(null===CSVal.tsE_discTopics)return pubsubz.subscribe("csval/get_topics",CSVal.get_posts),!1},!function(a){var b={},c=-1,d={};d.publish=function(a,c){return 1==CSVal.devMode&&console.log("published: "+a),!!b[a]&&(setTimeout(function(){for(var d=b[a],e=d?d.length:0;e--;)d[e].func(c)},0),!0)},d.subscribe=function(a,d){b[a]||(b[a]=[]);var e=(++c).toString();return b[a].push({token:e,func:d}),e},d.unsubscribe=function(a){for(var c in b)if(b[c])for(var d=0,e=b[c].length;e>d;d++)if(b[c][d].token===a)return b[c].splice(d,1),a;return!1},getPubSubz=function(){return d},a.pubsubz=getPubSubz()}(this,this.document),window.JSON&&!window.JSON.dateParser){var reISO=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/;JSON.dateParser=function(a,b){if("string"==typeof b){var c=reISO.exec(b);if(c)return new Date(b)}return b}}
