var $=jQuery,CSVal=CSVal||{},savedActivity=[],savedScores=[],savedMaxScore=[],currentIndex=0,gradedScoreObject={},gradeObject={},currentModel=null,currentQuestion=null,quizData={},SELECTORS={header:".header",content:".content",feedbacks:".feedbacks",actions:".actions"},ICON_NAMES={correct:"done",wrong:"clear",partial:"timelapse"},BUTTONS={startQuiz:{label:"Start",className:"start-quiz"},finish:{label:"Next Topic",className:"finish"},resetAll:{label:"Reset",className:"reset"},checkAnswer:{label:"Submit",className:"submit"},hint:{label:"Hint",className:"hint"},previous:{label:"Back",className:"back"},cont:{label:"Next",className:"next"},endQuiz:{label:"Next",className:"end-quiz"}};try{CSVal.init()}catch(e){console.error("CSVal not initiated",e)}function setContext(a,b){if(!b){b={}}if(!b.ou){try{b.ou=CSVal.context.ouID}catch(c){b.ou=null}}if(!b.ui){try{$.get(SMI.getUrls("who_am_i"),function(f){b.ui=f.Identifier;buildQuiz(a,b)})}catch(c){b.ui=null;buildQuiz(a,b)}}else{buildQuiz(a,b)}}function getQuestionModel(a){switch(a){case"Matching":return Matching;case"All That Apply":return AllThatApply;case"Multiple Choice":return MultipleChoice;case"Fill In The Blank":return FillInTheBlank;case"Math":return Arithmetic;case"Ordering":return Ordering;default:return null}}function getQuiz(a){if(parent){parent.document.body.scrollTop=0}currentQuestion=quizData.Questions[a];currentModel=getQuestionModel(currentQuestion.questionType);if(savedActivity[a]){document.body.replaceChild(savedActivity[a],document.querySelector("main"));addButtonEvents()}else{if(currentModel){var c=getQuestion(currentModel,quizData,currentQuestion);var b=getAnswer(currentModel,quizData,currentQuestion);repopulateContainer(SELECTORS.header,c);repopulateContainer(SELECTORS.content,b);repopulateContainer(SELECTORS.feedbacks);repopulateContainer(SELECTORS.actions,getQuizButtons(quizData))}else{console.error("No Model of "+currentQuestion.questionType)}}}function startQuiz(a){initialSaved();if(!a||a instanceof Event){a=0}currentIndex=a;getQuiz(currentIndex)}function havePostQuizText(a){return a.postQuizText&&a.postQuizText!=="none"}function havePostQuizMedia(a){return a.postQuizMedia&&a.postQuizMedia.length>0}function havePostQuiz(a){return !a.General.skipPostQuiz&&(havePostQuizText(a.General)||havePostQuizMedia(a.General))}function getPreQuiz(d){var a=getText(d.General.instructions,"quiz-instructions"),f=getText(d.General.preQuizText,"quiz-pre-text"),c=[],b;if(a){c.push(a)}if(f){c.push(f)}if(c.length===0){c.push(getText("Click <b>Start</b> to begin your quiz.","quiz-instructions"))}if(gradedScoreObject.DisplayedGrade&&gradedScoreObject.PointsNumerator){c.push(getText("You scored <b>"+gradedScoreObject.DisplayedGrade+"</b> your previous attempt.","graded-text"))}return c}function getPostQuiz(d,b){var g,a,c=[],f=savedScores.reduce(function(i,j){return i+j},0),h=savedMaxScore.reduce(function(i,j){return i+j},0);g=document.createElement("p");g.classList.add("quiz-post-text","graded-text");g.innerHTML="You scored <b>"+(f/h*100).toFixed(2)+"%</b> on this assessment.";c.push(g);return c}function getMedia(g,b){var f,c;switch(g.type.toUpperCase()){case"VIDEO":f=document.createElement("video");f.setAttribute("controls","controls");break;case"YOUTUBEVIDEO":f=document.createElement("iframe");f.setAttribute("frameborder","0");f.setAttribute("allowfullscreen","");break;case"IMAGE":f=document.createElement("img");break;default:console.error("No support for media "+g.type);return}f.setAttribute("src",g.src);f.setAttribute("alt",g.alt||g.type);if(g.type.toUpperCase()==="YOUTUBEVIDEO"){c=document.querySelector(b);if(c){var d=g.width&&g.width!=="none"?g.width:c.offsetWidth,a=d*0.5625;f.setAttribute("width",d);f.setAttribute("height",a)}else{f.setAttribute("width",480);f.setAttribute("height",480*0.5625)}}else{if(g.height&&g.height!=="none"&&!f.getAttribute("height")){f.setAttribute("height",g.height)}if(g.width&&g.width!=="none"&&!f.getAttribute("width")){f.setAttribute("width",g.width)}}return f}function endQuiz(){if(havePostQuiz(quizData)){repopulateContainer(SELECTORS.header);repopulateContainer(SELECTORS.feedbacks);repopulateContainer(SELECTORS.content,getPostQuiz(quizData,SELECTORS.content));repopulateContainer(SELECTORS.actions,getPostQuizButtons())}else{finish()}}function finish(){var b=savedScores.reduce(function(d,f){return d+f},0),c=savedMaxScore.reduce(function(d,f){return d+f},0);if(parent&&parent.document){var a=parent.document.querySelector("a.d2l-iterator-button-next");if(a){parent.document.querySelector("a.d2l-iterator-button-next").click()}else{console.warn("Cannot find next button");console.log(incomingGradeValue)}}else{console.warn("Cannot find next button");console.log(incomingGradeValue)}}function getPreQuizButtons(){return[getButtonElement(BUTTONS.startQuiz)]}function getPostQuizButtons(){var a=BUTTONS.startQuiz;a.label="Restart";return[getButtonElement(a),getButtonElement(BUTTONS.finish)]}function getQuizButtons(c){var b=[],a;if(currentIndex>0&&c.General.allowPrevious){b.push(getButtonElement(BUTTONS.previous))}if(savedActivity[currentIndex]||savedScores[currentIndex]!==null){if(currentIndex===c.Questions.length-1){if(havePostQuiz(c)){b.push(getButtonElement(BUTTONS.endQuiz))}else{a=BUTTONS.startQuiz;a.label="Restart";b.push(getButtonElement(a));b.push(getButtonElement(BUTTONS.finish))}}else{b.push(getButtonElement(BUTTONS.cont))}}else{if(c.General.allowReset||currentQuestion.reset){b.push(getButtonElement(BUTTONS.resetAll))}if(c.General.showHints&&((currentQuestion.hintText&&currentQuestion.hintText.toUpperCase()!=="NONE")||(currentQuestion.hintMedia&&currentQuestion.hintMedia.toUpperCase()!=="NONE"))){b.push(getButtonElement(BUTTONS.hint))}b.push(getButtonElement(BUTTONS.checkAnswer))}return b}function getButtonElement(b){var a=document.createElement("button");a.classList.add(b.className);a.appendChild(document.createTextNode(b.label));a.addEventListener("click",getButtonEvent(b.className));return a}function addButtonEvents(){document.querySelectorAll("div.answer-actions button, div.feedback-actions button, div.actions button").forEach(function(a){a.addEventListener("click",getButtonEvent(a.className))})}function getButtonEvent(a){switch(a){case"start-quiz":return startQuiz;case"reset":return resetAll;case"submit":return checkAnswer;case"hint":return getHint;case"back":return goBack;case"next":return nextQuestion;case"end-quiz":return endQuiz;case"finish":return finish;default:return null}}function getQuizHeader(c){var a="h"+(c.General.HeadingLevel||1),b=document.createElement(a);b.appendChild(document.createTextNode(c.General.QuizName||"Quiz"));return b}function setQuizHeader(a){$("header").empty().append(a)}function initialSaved(){savedActivity=[],savedScores=[],savedMaxScore=[];quizData.Questions.forEach(function(){savedActivity.push(null);savedScores.push(null);savedMaxScore.push(null)})}function buildQuiz(a,b){$.getJSON(a,function(f){quizData=f;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){quizData.mobileDevice=true}quizData.Questions=quizData.Questions.filter(function(i){return !i.skip});var d=getQuizHeader(quizData);setQuizHeader(d);b.gi=quizData.General.gradeId;b.ai=quizData.General.awardId;SMI.init(b);if(!quizData.General.gradeId){var h=getPreQuiz(quizData);var c=getPreQuizButtons();repopulateContainer(SELECTORS.content,h);repopulateContainer(SELECTORS.actions,c)}else{SMI.getGrade(function(i){if(i.status===200){gradeObject=i.responseJSON}});var g=function(j){if(j.status===200){gradedScoreObject=j.responseJSON}var k=getPreQuiz(quizData);var i=getPreQuizButtons();repopulateContainer(SELECTORS.content,k);repopulateContainer(SELECTORS.actions,i)};if(!b.ui){g({})}else{SMI.getUserGrade(g)}}})}function getAnswer(c,d,b){var a=[];if(c.getAnswer){a=c.getAnswer(b,d)}return a}function checkAnswer(){var a,d,f,b;if(currentModel.checkAnswer){a=currentModel.checkAnswer(currentQuestion);savedScores[currentIndex]=a.score;if(!savedMaxScore[currentIndex]){savedMaxScore[currentIndex]=a.maxScore}var c=getFeedback(currentModel,quizData,a);repopulateContainer(SELECTORS.feedbacks,c);repopulateContainer(SELECTORS.actions,getQuizButtons(quizData))}else{console.error("No default checking.")}if(currentIndex===quizData.Questions.length-1&&quizData.General.gradeId){d=savedScores.reduce(function(g,h){return g+h},0);f=savedMaxScore.reduce(function(g,h){return g+h},0);b=SMI.generateIncomingGradeValue(d,"Graded by SMI IAT");SMI.putUserGrade(null,b);if(d===f&&quizData.General.awardId){SMI.issueAward(null,SMI.generateIssuedAwardCreate("Scored 100% on "+quizData.General.QuizName+".","Issued by Smith Custom IAT"))}}}function getHint(){var c=getText(currentQuestion.hintText,"hint-text"),a=getHintMedia(currentQuestion.hintMedia),b=document.createElement("div");b.appendChild(c);a.forEach(function(d){b.appendChild(d)});showDialog("Hint",b)}function createDialog(h,d,g){var b=document.createElement("div"),i=document.createElement("div"),f=getIcon(ICON_NAMES.wrong),c=document.createElement("div"),a=document.createElement("div");if(!(d instanceof HTMLElement)){a.innerHTML=d;d=a}b.classList.add("dialog-backdrop");i.classList.add("dialog-header");d.classList.add("dialog-content");f.classList.add("close-dialog-button");c.classList.add("dialog");a=document.createElement("span");a.appendChild(document.createTextNode(h));i.appendChild(a);f.addEventListener("click",closeDialog);b.addEventListener("click",closeDialog);i.appendChild(f);c.appendChild(i);c.appendChild(d);if(g instanceof HTMLElement){g.classList.add("dialog-actions");c.appendChild(g)}b.appendChild(c);return b}function showDialog(d,b,c){var a=createDialog(d,b,c);if(document.querySelector(".dialog-backdrop")){document.querySelector(".dialog-backdrop").remove()}document.querySelector("main").appendChild(a)}function closeDialog(a){if(a instanceof Event){if(this!=a.target){return}}document.querySelector(".dialog-backdrop").remove()}function getHintMedia(a){var b=[];if(Array.isArray(a)){a.forEach(function(d){var c;if(d.type=="image"){c="img"}else{if(d.type=="video"){c="video"}}if(c){var f=document.createElement(c);f.setAttribute("src",d.src);f.setAttribute("alt",d.description);f.setAttribute("class","media-item");b.push(f)}})}return b}function goBack(){saveCurrentQuestion();getQuiz(--currentIndex)}function nextQuestion(){saveCurrentQuestion();if(++currentIndex===quizData.Questions.length){getPostQuiz(quizData)}else{getQuiz(currentIndex)}}function resetAll(){savedActivity[currentIndex]=null;savedScores[currentIndex]=null;getQuiz(currentIndex)}function saveCurrentQuestion(){savedActivity[currentIndex]=document.querySelector("main").cloneNode(true)}function repopulateContainer(a,b){if(b===undefined||b===null){b=[]}$(a).empty();b.forEach(function(c){if(c instanceof HTMLElement){$(a).append(c)}})}function getQuestion(d,a,f){var g="Question "+(currentIndex+1)+" of "+a.Questions.length,c=document.createElement("h2"),b;c.appendChild(document.createTextNode(g));c.classList.add("question-title");if(d&&d.getQuestion){b=d.getQuestion(f,a)}else{b=[createElement("p",f.questionText,"question")]}return[c].concat(b)}function getFeedback(d,c,a){var i=document.createElement("h2");i.appendChild(document.createTextNode("Result "));i.classList.add("feedback-title");var h=document.createElement("h3");var f="You scored "+a.score+"/"+a.maxScore+"!";var g;if(a.score==a.maxScore){g=getIcon(ICON_NAMES.correct);g.classList.add("correct");f="Your answer was correct. +"+a.score}else{if(a.score>0){g=getIcon(ICON_NAMES.partial);g.classList.add("partial");f="Your answer was partially correct. +"+a.score}else{g=getIcon(ICON_NAMES.wrong);g.classList.add("wrong");f="Your answer was incorrect."}}h.classList.add("result-score-text");h.appendChild(g);h.appendChild(document.createTextNode(f));var b=[i,h];if(d&&d.getFeedback){b=b.concat(d.getFeedback(a,c))}return b}function getText(c,b){if(c&&c.trim().length>0&&c!="none"){var a=createElement("p",null,{className:b});a.innerHTML=c;return a}return null}function createElement(a,d,b){var c=document.createElement(a);if(d){var d=document.createTextNode(d);c.appendChild(d)}if(b&&typeof(b)==="object"){Object.keys(b).forEach(function(f){c[f]=b[f]})}return c}function getFeedbackClassName(b,a){if(a){return b+" correct"}else{return b+" wrong"}}function getIcon(c,a){var b=createElement("i",c,{className:"material-icons"});if(a){b.setAttribute("onclick",a)}return b}function onChange(a){if(currentModel.onChange){currentModel.onChange(a)}}function onTouchMove(a){if(currentModel.onTouchMove){a.preventDefault();currentModel.onTouchMove(a)}};